<!DOCTYPE html>
<html lang="en" manifest="nyan-letters.appcache">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- This disables zooming. Something we don't want to do on mobile devices.
         http://stackoverflow.com/questions/4472891/how-can-i-disable-zoom-on-a-mobile-web-page
    -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <!-- This will make the status bar in iOS transparent and let the contents show through.
         The countdown progress bar is sized just about perfectly so you can see it going down under the status.
         http://www.bennadel.com/blog/1945-using-the-cache-manifest-with-iphone-s-app-mode-for-native-web-applications.htm
    -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    
    <title>~ Nyan Letters ~</title>

    <link href="css/html5doctor-reset.css" rel="stylesheet">
    <!-- Comic Neue Fonts: http://comicneue.com/ -->
    <link href="css/font.css" rel="stylesheet">
    <!--<link href="viewport-styles.css" rel="stylesheet">-->
    <link href="css/rem-styles.css" rel="stylesheet">
    
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!--
        Ok, here are my notes:
            -----
            We are cloning Meow Letters!
                https://github.com/ana-balica/meow_letters
            -----
            For the base styling, I'm gonna pick one of these:
                normalize.css - http://necolas.github.io/normalize.css/
                bootstrap - http://getbootstrap.com/components/
                foundation - http://foundation.zurb.com/docs/components/kitchen_sink.html
            A reset css is also viable, but I really don't feel like styling everything myself.
            Here is some research pertaining to these choices:
                http://stackoverflow.com/questions/3485720/which-html5-reset-css-do-you-use-and-why
                http://stackoverflow.com/questions/6887336/what-is-the-difference-between-normalize-css-and-reset-css
            -----
            For sizing the game container to make it look good, I fix it to an aspect ratio and use all vh units.
            This lets me center the game on the screen and make the game resize nicely.
            Then I can add a background color to the body element to either have black bars or make it match the game component backgrounds.
                http://stackoverflow.com/questions/20590239/maintain-aspect-ratio-of-div-but-fill-screen-width-and-height-in-css
            But of course, this isn't perfect on all devices.
            It'd probably be best to get the game too fit as close as possible to the device's aspect ratio as possible.
            We can also account for portrait vs landscape.
            For this, we can use a combination of css-media queries and some new CSS3 properties:
                http://css-tricks.com/css-media-queries/
                http://www.sitepoint.com/media-queries-look-different-media-features/
                https://developer.mozilla.org/en-US/docs/Web/Guide/CSS/Media_queries
            Those above three are all you need to read, but these can also help:
                http://stackoverflow.com/questions/5725838/difference-between-aspect-ratio-and-device-aspect-ratio-in-css-media-queries
                http://cssmediaqueries.com/overview.html
            -----
            Now we are getting close to making the HTML5 game look good on mobile since we have no vertical scrolling
            and can adapt to various device aspect ratios.
            But the app (both online and offline) still show the address bar among other controls.
            We can use metadata tags to disable these and make it appear to work like a fullscreen app.
                http://www.bennadel.com/blog/1945-using-the-cache-manifest-with-iphone-s-app-mode-for-native-web-applications.htm
            For some extra troubleshooting in case that simple solution doesn't work, see these:
                http://www.html5rocks.com/en/mobile/fullscreen/?redirect_from_locale=es
                http://stackoverflow.com/questions/6429492/how-do-you-keep-an-iphone-ipad-web-app-in-full-screen-mode
                http://stackoverflow.com/questions/8336102/using-offline-application-cache-in-ios-and-in-full-screen-app-mode-it-opens-othe
            -----
            Ok, so how to we make this work 100% offline?
            HTML5 application caching with a manifest file.
                http://www.html5rocks.com/en/tutorials/appcache/beginner/
                http://www.sitepoint.com/creating-offline-html5-apps-with-appcache/
                http://sixrevisions.com/web-development/html5-iphone-app/
            We also want to use webfonts so we can't forget that either:
                http://stackoverflow.com/questions/7042834/is-it-possible-to-load-webfonts-through-the-offline-storage-cache-manifest
                http://stackoverflow.com/questions/11753327/how-to-use-google-web-font-in-an-iphone-app-built-with-phonegap
            Roboto Font is what is used in Meow Letters:
                http://www.google.com/fonts#UsePlace:use/Collection:Roboto
                https://developer.mozilla.org/en-US/docs/Web/CSS/font-weight
                http://www.maketecheasier.com/use-google-roboto-font-everywhere/
            -----
            Finally, we get into building the actual game and it's various screens and components.
            To do that, we will need some CSS properties that will make things look nice.
            Specifically:
                visibility - use this to hide or reveal entire screens
                z-index - to separate the screens so that we have no possible rendering collisions
                    (especially important with position absolute. 
                        Absolutely positioned elements (our whole game screens) won't effect each others' renderings,
                        but z-index will let use define which screens go on top of the other.
                        That way we don't have to use any guesswork based on which chunk of html code came first.)
                    This also let's use have overlay screens and/or components.
                background: rgba() - to make overlays have transparent backgrounds to give us that glassy cover feel
            Useful documentation:
                http://css-tricks.com/almanac/properties/z/z-index/
                http://css-tricks.com/rgba-browser-support/
                    http://stackoverflow.com/questions/5662178/opacity-of-divs-background-without-affecting-contained-element-in-ie-8
                    http://stackoverflow.com/questions/11807286/how-to-make-div-background-color-transparent-in-css
                http://css-tricks.com/almanac/properties/v/visibility/
            Also, the difference between visibility and display:
                http://learnlayout.com/display.html
            -----
            Countdown Progress Bar Timer
            I largely copied the code from these examples:
                http://stackoverflow.com/questions/24530908/showing-a-time-countdown-progress-bar
                http://workshop.rs/2012/12/animated-progress-bar-in-4-lines-of-jquery/
                http://stackoverflow.com/questions/9651482/countdown-timer-with-progress-bar
            -----
            Various notes on javascript.
            Document.ready vs window.onload vs document.onload:
                http://stackoverflow.com/questions/3698200/window-onload-vs-document-ready
                http://stackoverflow.com/questions/588040/window-onload-vs-document-onload
                https://developer.mozilla.org/en-US/docs/Web/API/GlobalEventHandlers.onload
            Clearing timeouts if I need it:
                http://www.sitepoint.com/settimeout-example/
            Faster Math.max and Math.min:
                http://ejohn.org/blog/fast-javascript-maxmin/
            -----
            Styling notes:
                redefine everything in % or vmin/vmax, like fonts and tables
                this will allow everything to resize nicely relative to each other and prevents the layout from breaking
                    http://css-tricks.com/viewport-sized-typography/
                vertically centering elements
                    http://www.smashingmagazine.com/2013/08/09/absolute-horizontal-vertical-centering-css/
                    http://zerosixthree.se/vertical-align-anything-with-just-3-lines-of-css/
    -->
  </head>
  <body>
    <!-- Game Screen -->
    <div id="gamescreen" class="game-container">
        <div class="score-table">
            <div id="progressBar">
                <div></div>
            </div>
            <h1 id="level">Level 1</h1>
            <h2 id="score">Score 15</h2>
        </div>
        <div class="game-board">
            <table id="game-grid">
                <!-- filled in dynamically -->
            </table>
        </div>
    </div>
    <!-- Gameover Overlay -->
    <div id="gameover-overlay" class="game-container game-overlay">
        <div class="game-board">
            <div id="gameover">
                <h1>GAMEOVER!</h1>
                <!-- Randomly capping length at 26.
                     No reason other than, I need to cap it at something.
                -->
                <input type="text" name="username" maxlength="26" />
                <button id="submit-score-button" class="control-button">Save Score</button>
                <button class="control-button dummy-saving-button">Saving...</button>
                <h2>Saved!</h2>
                <button id="restart-button" class="control-button">Play Again</button>
                <button class="control-button homescreen-button">Close</button>
            </div>
        </div>
    </div>
    <!-- Home Screen -->
    <div id="homescreen" class="game-container">
        <h1 id="title">Nyan Letters</h1>
        <button id="new-game-button">New Game</button>
        <button id="scoreboard-button">Highscores</button>
        <button id="settings-button">Settings</button>
    </div>
    <!-- Scoreboard Screen -->
    <div id="scoreboard" class="game-container">
        <h1>High Scores</h1>
        <ol id="scorelist">
            <!-- filled in dynamically -->
        </ol>
        <button class="control-button homescreen-button">Close</button>
    </div>
    <!-- Settings Screen -->
    <div id="settings" class="game-container">
        <h1>Game Settings</h1>
        <label for="username">Name:</label>
        <!-- Randomly capping length at 26.
             No reason other than, I need to cap it at something.
        -->
        <input type="text" name="username" maxlength="26" />
        <label>Difficulty:</label>
        <button id="easy-setting" class="difficulty-button selected">EASY</button>
        <button id="normal-setting" class="difficulty-button">NORMAL</button>
        <button id="hard-setting" class="difficulty-button">HARD</button>
        <button id="save-settings-button" class="control-button">Save</button>
        <button class="control-button homescreen-button">Close</button>
    </div>
    <!-- jQuery for animations and I just like using it over straight javascript -->
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <!-- for animating background color changes
         http://stackoverflow.com/questions/190560/jquery-animate-backgroundcolor
         http://stackoverflow.com/questions/20540807/changing-background-color-using-jquery-animate
         https://github.com/jquery/jquery-color
    -->
    <script type="text/javascript" src="js/jquery.color.js"></script>
    <!-- Use fastclick.js to get rid of as much of the 300ms delay as possible
         that is applied by default on mobile devices for clicking.
         This will make the game seem much more responsive and smooth.
         http://updates.html5rocks.com/2013/12/300ms-tap-delay-gone-away
         https://github.com/ftlabs/fastclick
    -->
    <script type='application/javascript' src='js/fastclick.js'></script>
    
    <script>       
        /**
         * I'm using the YUI Module Pattern to keep my code clean.
         * http://www.yuiblog.com/blog/2007/06/12/module-pattern/
         * http://stackoverflow.com/questions/2613310/ive-heard-global-variables-are-bad-what-alternative-solution-should-i-use
         * http://stackoverflow.com/questions/1841916/how-to-avoid-global-variables-in-javascript
         */ 
        var nyanGame = function () {
            /**
             * All global game variables and settings.
             * Everything is kept in this module as to not polute the real global namespace.
             */
            var difficulty = 5; // game board size (default: 5)
            var filledCells = 0; 
            var setSize = 2; // pairs, triples, etc.
            var selectedCount = 0;
            // http://stackoverflow.com/questions/11500492/what-are-the-best-practices-to-follow-when-declaring-an-array-in-javascript#11500550
            var selectedCells = [];
            
            // All of these are in seconds.
            var timeleft = 7;
            var timetotal = 7;
            var bonustime = timetotal;
            var penaltytime = 0;
            
            // This is the current progress bar animation timeout.
            var timeout = null;
            
            var currentLevel = 1;
            var currentScore = 0;

            // Game Save Data
            /**
             * Setting this will prevent collisions if I have multiple games on 
             * the same domain. The current domain can be checked using:
             *     document.domain
             * https://developer.mozilla.org/en-US/docs/Web/API/document.domain
             * http://stackoverflow.com/questions/9742395/scope-of-sessionstorage-and-localstorage
             */
            var gameDomain = (document.domain == null || document.domain == '' ? 'file' : document.domain) + '.nyan-letters.';
            var canSave = false;
            // These are all set to their defaults initially.
            var username = 'Doraemon';
            var EASY = 'EASY'; var NORMAL = 'NORMAL'; var HARD = 'HARD'; // possible game modes (static vars)
            var gameMode = EASY;
            var topTen = [
                {'username': 'A', 'score': '100'},
                {'username': 'B', 'score': '90'},
                {'username': 'C', 'score': '80'},
                {'username': 'D', 'score': '70'},
                {'username': 'E', 'score': '60'},
                {'username': 'F', 'score': '50'},
                {'username': 'G', 'score': '40'},
                {'username': 'H', 'score': '30'},
                {'username': 'I', 'score': '20'},
                {'username': 'J', 'score': '10'}
            ]

            /**
             * Private game functions.
             */
             
            /**
             * Use Web Storage (aka: Local Storage or DOM Storage)
             * because it has the most browser support and the 
             * cons don't hurt us since our use of data is so simple.
             * http://www.html5rocks.com/en/tutorials/offline/whats-offline/
             * http://www.html5rocks.com/en/tutorials/offline/storage/
             * http://stackoverflow.com/questions/6849798/html5-client-storage-websqldatabase-vs-webstorage-vs-indexed-database
             * http://csimms.botonomy.com/2011/05/html5-storage-wars-localstorage-vs-indexeddb-vs-web-sql.html
             * http://www.html5rocks.com/en/features/storage
             * http://diveintohtml5.info/storage.html
             */
            var supports_html5_storage = function() {
                try {
                    return 'localStorage' in window && window['localStorage'] !== null;
                } catch (e) {
                    return false;
                }
            }
            
            // There is a 5MB limit, so just in case...
            // http://stackoverflow.com/questions/7667958/clear-localstorage
            var resetSaveData = function() {
                localStorage.clear();
            }
            
            var printGameData = function() {
                console.log('username = ' + username);
                console.log('gameMode = ' + gameMode);
                for (var i = 0; i < 10; i++) {
                    console.log((i + 1) + '. ' + topTen[i].username + ' ~~~ ' + topTen[i].score);
                }
            }
            
            // http://stackoverflow.com/questions/979256/sorting-an-array-of-javascript-objects
            var sort_by = function(field, reverse, primer) {
                var key = primer ? 
                    function(x) {return primer(x[field])} : 
                    function(x) {return x[field]};

                reverse = [-1, 1][+!!reverse];

                return function (a, b) {
                    return a = key(a), b = key(b), reverse * ((a > b) - (b > a));
                }
            }
            
            // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/round
            /**
             * Decimal adjustment of a number.
             *
             * @param	{String}	type	The type of adjustment.
             * @param	{Number}	value	The number.
             * @param	{Integer}	exp		The exponent (the 10 logarithm of the adjustment base).
             * @returns	{Number}			The adjusted value.
             */
            function decimalAdjust(type, value, exp) {
                // If the exp is undefined or zero...
                if (typeof exp === 'undefined' || +exp === 0) {
                    return Math[type](value);
                }
                value = +value;
                exp = +exp;
                // If the value is not a number or the exp is not an integer...
                if (isNaN(value) || !(typeof exp === 'number' && exp % 1 === 0)) {
                    return NaN;
                }
                // Shift
                value = value.toString().split('e');
                value = Math[type](+(value[0] + 'e' + (value[1] ? (+value[1] - exp) : -exp)));
                // Shift back
                value = value.toString().split('e');
                return +(value[0] + 'e' + (value[1] ? (+value[1] + exp) : exp));
            }

            // Decimal round
            if (!Math.round10) {
                Math.round10 = function(value, exp) {
                    return decimalAdjust('round', value, exp);
                };
            }
            // Decimal floor
            if (!Math.floor10) {
                Math.floor10 = function(value, exp) {
                    return decimalAdjust('floor', value, exp);
                };
            }
            // Decimal ceil
            if (!Math.ceil10) {
                Math.ceil10 = function(value, exp) {
                    return decimalAdjust('ceil', value, exp);
                };
            }
            
            var resetGameData = function() {
                filledCells = 0; 
                selectedCount = 0;
                emptyAnArray(selectedCells);
                timeleft = timetotal;
                stopGameTimer()
                currentLevel = 1;
                currentScore = 0;
            }

            /**
             * Here are the game rules and how things ramp up in difficulty.
             * 
             * ***** Game Basics *****
             * The game is composed of an NxN board.
             * This board is filled with X letters + 1 to start.
             * If your timer reaches 0, then another X letters are added.
             * Letters can be removed if a user makes a chain of X correctly.
             *     If they do this, then bonustime is added.
             *     They also get points added to their score.
             * If the user makes an incorrect chain of X, the letters stay.
             *     If they get it wrong, penaltytime is added (e.g., docked).
             * The game ends if the timer hits 0 and there is no room to add 
             *   X new letters.
             *
             * ***** Difficulty Ramping *****
             * The start of the game can be harder by setting the difficulty.
             *   This also effects what rules are changed after you level up.
             * The game increases in difficulty whenever you level up.
             * These changes can include (based on mode):
             *     Less totaltime.
             *     More or less bonustime.
             *     Greater penalty time.
             *     Increased setSize.
             *     (possibly) Bigger gameboard
             *     (maybe todo?) Penalty letters being added.
             *
             * ***** Extra Features / Easter Eggs *****
             * Combo/Chain counting would fit in well with the theme.
             *     You can also do things like using the combo as a multiplier 
             *     ala: Floor(comboCount/10) * bonustime = what we add
             *
             */
            var setGameToDifficulty = function() {
                console.log('Setting game difficulty to: ' + gameMode);
                if (gameMode == NORMAL) {
                    difficulty = 10; // game board size (default: 5)
                    setSize = 3; // pairs, triples, etc.
                    timeleft = 5;
                    timetotal = 5;
                    bonustime = 3;
                    penaltytime = -2;
                } else if (gameMode == HARD) {
                    difficulty = 3; // game board size (default: 5)
                    setSize = 6; // pairs, triples, etc.
                    timeleft = 5;
                    timetotal = 5;
                    bonustime = 3;
                    penaltytime = -2;
                } else { // (default mode) gameMode == EASY or was oddly not set which would be a bug in the code
                    // These initial settings all mimic the original game's defaults.
                    difficulty = 5; // game board size (default: 5)
                    setSize = 2; // pairs, triples, etc.
                    timeleft = 7;
                    timetotal = 7;
                    bonustime = timetotal;
                    penaltytime = 0;
                }
            }
            
            var setGameGridStylesForDifficulty = function() {
                // various testing has how these settings (default in the css)
                // to look the best and work well at all scales for a 5x5 grid.
                // so we can use this as a base to scale everything from
                // when the grid size is changed (difficulty var).
                var baseFontSize = 8;
                var baseLineHeight = 9;
                var baseCellDimension = 19;
                var baseGameGridDimension = 95;
                $('#game-grid td').css({
                    'font-size' : Math.round10((baseGameGridDimension * baseFontSize)/(difficulty * baseCellDimension), -2) + 'rem',
                    'line-height': Math.round10((baseGameGridDimension * baseLineHeight)/(difficulty * baseCellDimension), -2) + 'rem',
                    'width': Math.round10(baseGameGridDimension/difficulty, -2) + '%',
                    'height': Math.round10(baseGameGridDimension/difficulty, -2) + '%'
                });
            }

            // first clear the table of previous setups
            // http://stackoverflow.com/questions/3955229/remove-all-child-elements-of-a-dom-node-in-javascript
            var clearChildElements = function(elementId) {
                var myNode = document.getElementById(elementId);
                if (myNode !== null) {
                    while (myNode.firstChild) {
                        myNode.removeChild(myNode.firstChild);
                    }
                }
            }
            
            // difficulty: is the grid dimensions. obviously bigger grids are harder.
            var createGameGrid = function() {
                clearChildElements('game-grid');
                
                var grid = '';
                for (var i = 0; i < difficulty; i++) {
                    grid += '<tr>';
                    for (var j = 0; j < difficulty; j++) {
                        grid += '<td id="cell-' + i + '-' + j + '"></td>';
                    }
                    grid += '</tr>';
                }
                $('#game-grid').append($(grid));
                
                setGameGridStylesForDifficulty();
            }
                
            // http://stackoverflow.com/questions/1527803/generating-random-numbers-in-javascript-in-a-specific-range
            /**
             * Returns a random integer between min (inclusive) and max (inclusive)
             * Using Math.round() will give you a non-uniform distribution!
             */
            var getRandomInt = function(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            /**
             * http://www.asciitable.com/
             * http://stackoverflow.com/questions/5462676/converting-ascii-to-text
             * http://stackoverflow.com/questions/5898656/test-if-an-element-contains-a-class
             * 
             */
            var addLetterSet = function() {
                console.log('filledCells = ' + filledCells);
                if (filledCells + setSize > difficulty * difficulty) {
                    return false;
                }
                
                var generated = 0;
                // 90 == Z so the last letter we should pick is 1 less than the set size
                var letter = getRandomInt(65, 90 - (setSize - 1));
                
                while (generated < setSize) {
                    var x, y;
                    x = getRandomInt(0, difficulty - 1);
                    y = getRandomInt(0, difficulty - 1);
                    console.log('(' + x + ', ' + y + ')');
                    if (!$( '#cell-' + x + '-' + y ).hasClass('active') && !$( '#cell-' + x + '-' + y ).hasClass('selected')) {
                        console.log("Open cell!");
                        $( '#cell-' + x + '-' + y ).text(String.fromCharCode(letter + generated));
                        $( '#cell-' + x + '-' + y ).addClass('active');
                        generated++;
                        filledCells++;
                    }
                }
                console.log('filledCells post generating = ' + filledCells);
                return true;
            }
            
            // Single fill function for use to add extra letters to throw people off.
            var addRandomLetter = function() {
                if (filledCells + 1 > difficulty * difficulty) {
                    return false;
                }
                
                var letter = getRandomInt(65, 90);
                var generated = 0;
                while (generated < 1) {
                    var x, y;
                    x = getRandomInt(0, difficulty - 1);
                    y = getRandomInt(0, difficulty - 1);
                    console.log('(' + x + ', ' + y + ')');
                    if (!$( '#cell-' + x + '-' + y ).hasClass('active') && !$( '#cell-' + x + '-' + y ).hasClass('selected')) {
                        console.log("Open cell!");
                        $( '#cell-' + x + '-' + y ).text(String.fromCharCode(letter + generated));
                        $( '#cell-' + x + '-' + y ).addClass('active');
                        generated++;
                        filledCells++;
                    }
                }
                return true;
            }

            // http://stackoverflow.com/questions/3954438/remove-item-from-array-by-value
            var removeFromArray = function(arr) {
                var what, a = arguments, L = a.length, ax;
                while (L > 1 && arr.length) {
                    what = a[--L];
                    while ((ax= arr.indexOf(what)) !== -1) {
                        arr.splice(ax, 1);
                    }
                }
                return arr;
            }
            
            var currentChainLength = function() {
                // http://stackoverflow.com/questions/94037/convert-character-to-ascii-code-in-javascript
                // http://stackoverflow.com/questions/3010840/loop-through-array-in-javascript
                // http://stackoverflow.com/questions/183161/best-way-to-break-from-nested-loops-in-javascript
                // http://stackoverflow.com/questions/1564818/how-to-break-2-loops-in-javascript
                var chain = 0;
                for (chain; chain < selectedCells.length - 1; chain++) {
                    console.log($( '#' + selectedCells[chain] ).text().charCodeAt(0));
                    if ($( '#' + selectedCells[chain+1] ).text().charCodeAt(0) - $( '#' + selectedCells[chain] ).text().charCodeAt(0) != 1) {
                        return chain + 1; // break is the cheesy way to get out of the loop
                    }
                }
                return chain + 1; // add 1 before returning because of how we check the set
            }
            
            var emptyAnArray = function(arrayToEmpty) {
                // http://stackoverflow.com/questions/1232040/how-to-empty-an-array-in-javascript
                while(arrayToEmpty.length > 0) {
                    arrayToEmpty.pop();
                }
            }
            
            var emptySelectedCells = function() {
                for (var i = 0; i < selectedCells.length; i++) {
                    $( '#' + selectedCells[i] ).text('');
                    $( '#' + selectedCells[i] ).removeClass('selected');
                }
                filledCells -= selectedCount;
                emptyAnArray(selectedCells);
                selectedCount = 0;
            }
            
            var unselectSelectedCells = function() {
                for (var i = 0; i < selectedCells.length; i++) {
                    $( '#' + selectedCells[i] ).removeClass('selected');
                    $( '#' + selectedCells[i] ).addClass('active');
                }
                emptyAnArray(selectedCells);
                selectedCount = 0;
            }
            
            // http://api.jquery.com/animate/
            // Use animate with a callback.
            // In the callback closure, add new letters and reset the timer.
            // No need to stop since this was the animation that should finished.
            var startGameTimer = function() {
                var progressBarWidth = timeleft * $('#progressBar').width() / timetotal;
                $('#progressBar').find('div').animate({ width: progressBarWidth }, 0, 'linear');
                $('#progressBar').find('div').animate({ width: 0 }, timeleft * 1000, 'linear', function(){
                    if (addLetterSet()) {
                        updateGameTimer(timetotal);
                    } else {
                        console.log('gameover');
                        stopGameTimer();
                        gameover();
                    }
                });
            }
            
            // http://api.jquery.com/stop/
            var stopGameTimer = function() {
                $('#progressBar').find('div').stop(true, false);
            }
            
            var updateGameTimer = function(additionalTime) {
                updateTimeLeft(additionalTime);
                stopGameTimer();
                startGameTimer();
            }
            
            var updateTimeLeft = function(additionalTime) {
                var leftover = timetotal * ($('#progressBar').find('div').width() / $('#progressBar').width());
                // It'll be 0 if the game just started or just ended.
                if (leftover != 0) {
                    timeleft = leftover;
                }
                timeleft += additionalTime;
                // In the case the game just started,
                // timeleft would have been initialized to timetotal.
                timeleft = Math.min(timeleft, timetotal);
                console.log("updateTimeLeft, timetotal = " + timetotal + " timeleft = " + timeleft);
            }
            
            var calculatePoints = function(chain) {
                // TODO: how much score to add
                var points = 0;
                if (chain == setSize) {
                    return chain * chain;
                }
                return chain;
            }
            
            var updateScoreBy = function(points) {
                currentScore += points;
                $('#score').text('Score ' + currentScore);
            }
            
            var updateLevelBy = function(levels) {
                currentLevel += levels;
                $('#level').text('Level ' + currentLevel);
            }
            
            var gameover = function() {
                stopGameTimer();
                $('#gameover > input[name="username"]').val(username);
                $('#submit-score-button').css({
                    'visibility' : 'visible'
                });
                $('#gameover > input[name="username"]').fadeIn(0);
                $('#gameover > h2').fadeOut(0);
                $('#gameover > button.dummy-saving-button').fadeOut(0);
                $('#gameover-overlay').css({
                    'visibility' : 'visible'
                });
            }
            
            /**
             * What's public.
             */
            return  {
                selectCell: function(cellId) {
                    $('#' + cellId).removeClass('active');
                    $('#' + cellId).addClass('selected');
                    selectedCells.push(cellId);
                    selectedCount++;
                    if (selectedCount == setSize) {
                        var chain = currentChainLength();
                        console.log('chain = ' + chain);
                        
                        if (chain == setSize) {
                            console.log('score!');
                            emptySelectedCells();
                            addLetterSet();
                            // The original game just reset the timer.
                            // I'm just adding bonus time to make it harder.
                            // To replicate this, you can just set bonustime = totaltime
                            updateGameTimer(bonustime);
                        } else {
                            console.log('noMatch();');
                            unselectSelectedCells();
                            // original game would doc time when you get it wrong.
                            // we won't be doing that
                            updateGameTimer(penaltytime);
                        }
                        updateScoreBy(calculatePoints(chain));

                        console.log('filledCells post clear = ' + filledCells);
                    }
                },
                unselectCell: function(cellId) {
                    $('#' + cellId).removeClass('selected');
                    $('#' + cellId).addClass('active');
                    removeFromArray(selectedCells, cellId);
                    selectedCount--;
                },
                initGame: function() {
                    resetGameData();
                    setGameToDifficulty();
                    updateScoreBy(0);
                    updateLevelBy(0);
                    createGameGrid();
                    addLetterSet();
                    addRandomLetter();
                    $('#gameover-overlay').css({
                        'visibility' : 'hidden'
                    });
                    $('#submit-score-button').css({
                        'visibility' : 'hidden'
                    });
                    $('#homescreen').css({
                        'visibility' : 'hidden'
                    });
                    $('#gamescreen').css({
                        'visibility' : 'visible'
                    });
                    $('#gameover-overlay').css({
                        'visibility' : 'hidden'
                    });
                    startGameTimer();
                },
                loadSaveData: function() {
                    canSave = supports_html5_storage();
                    if (canSave) {
                        console.log('Local Storage is supported. Attempting to retrieve data...');
                        username = localStorage[gameDomain + 'username'] ? localStorage[gameDomain + 'username'] : username;
                        gameMode = localStorage[gameDomain + 'gameMode'] ? localStorage[gameDomain + 'gameMode'] : gameMode;
                        for (var i = 0; i < 10; i++) {
                            topTen[i].username = localStorage[gameDomain + 'username.' + i] ? localStorage[gameDomain + 'username.' + i] : topTen[i].username;
                            topTen[i].score = localStorage[gameDomain + 'score.' + i] ? localStorage[gameDomain + 'score.' + i] : topTen[i].score;
                        }
                        console.log('Data loaded and/or defaults set:');
                    } else {
                        console.log('No Local Storage support. No game data will be saved.');
                        console.log('Defaults are being used:');
                    }
                    printGameData();
                },
                saveData: function() {
                    // EVERYTHING in localStorage must be a string,
                    // so cheat and add '' to everything to coerce everything
                    // into a string.
                    // http://stackoverflow.com/questions/869773/what-is-the-fastest-and-safest-way-to-convert-any-type-variable-to-string-in-jav
                    localStorage[gameDomain + 'username'] = username + '';
                    localStorage[gameDomain + 'gameMode'] = gameMode + '';
                    topTen.sort(sort_by('score', false, parseInt));
                    for (var i = 0; i < 10; i++) {
                        localStorage[gameDomain + 'username.' + i] = topTen[i].username + '';
                        localStorage[gameDomain + 'score.' + i] = topTen[i].score + '';
                    }
                },
                showScoreBoard: function() {
                    topTen.sort(sort_by('score', false, parseInt));
                    clearChildElements('scorelist');
                    var scorelist = '';
                    for (var i = 0; i < 10; i++) {
                        scorelist += ('<li>' + topTen[i].username + ' <span class="push-right">' + topTen[i].score + '</span></li>');
                    }
                    $('#scorelist').append($(scorelist));
                
                    $('#homescreen').css({
                        'visibility' : 'hidden'
                    });
                    $('#gamescreen').css({
                        'visibility' : 'hidden'
                    });
                    $('#scoreboard').css({
                        'visibility' : 'visible'
                    });
                    $('#settings').css({
                        'visibility' : 'hidden'
                    });
                },
                showHomeScreen: function() {
                    $('#homescreen').css({
                        'visibility' : 'visible'
                    });
                    $('#gamescreen').css({
                        'visibility' : 'hidden'
                    });
                    $('#scoreboard').css({
                        'visibility' : 'hidden'
                    });
                    $('#settings').css({
                        'visibility' : 'hidden'
                    });
                    $('#gameover-overlay').css({
                        'visibility' : 'hidden'
                    });
                    $('#submit-score-button').css({
                        'visibility' : 'hidden'
                    });
                },
                showSettingsScreen: function() {
                    $('#save-settings-button').text('Save');
                    $('#settings > input[name="username"]').val(username);
                    $('#easy-setting').removeClass('selected');
                    $('#normal-setting').removeClass('selected');
                    $('#hard-setting').removeClass('selected');
                    if (gameMode == EASY) {
                        $('#easy-setting').addClass('selected');
                    } else if (gameMode == NORMAL) {
                        $('#normal-setting').addClass('selected');
                    } else if (gameMode == HARD) {
                        $('#hard-setting').addClass('selected');
                    } else {
                        console.log('Something is wrong with the difficulty settings.');
                        gameMode = EASY;
                        $('#easy-setting').addClass('selected');
                    }
                    
                    $('#homescreen').css({
                        'visibility' : 'hidden'
                    });
                    $('#gamescreen').css({
                        'visibility' : 'hidden'
                    });
                    $('#scoreboard').css({
                        'visibility' : 'hidden'
                    });
                    $('#settings').css({
                        'visibility' : 'visible'
                    });
                },
                saveSettings: function() {
                    console.log('Saving settings...');
                    username = $('#settings > input[name="username"]').val();
                    var selectedDifficulty = $('#settings').find('button.selected').attr("id");
                    if (selectedDifficulty == 'easy-setting') {
                        gameMode = EASY;
                    } else if (selectedDifficulty == 'normal-setting') {
                        gameMode = NORMAL;
                    } else if (selectedDifficulty == 'hard-setting') {
                        gameMode = HARD;
                    } else {
                        console.error('ERROR: Something wrong with the ids on the settings screen.');
                    }
                    console.log('username set to ' + username);
                    console.log('gameMode set to ' + gameMode);
                },
                saveScore: function() {
                    username = $('#gameover > input[name="username"]').val();
                    console.log('saving score: | ' + username + ' | ' + currentScore + ' |');
                    topTen.push({
                        'username': username,
                        'score': currentScore
                    });
                }
            };
        }(); // the parens here cause the anonymous function to execute and return
    
        /**
         * All action handlers.
         */
        $("#new-game-button").click(function(event) {
            nyanGame.initGame();
        });
        
        $("#scoreboard-button").click(function(event) {
            nyanGame.showScoreBoard();
        });
        
        $("button.homescreen-button").click(function(event) {
            nyanGame.showHomeScreen();
        });
        
        $("#settings-button").click(function(event) {
            nyanGame.showSettingsScreen();
        });
        
        $("button.difficulty-button").click(function(event) {
            $('#easy-setting').removeClass('selected');
            $('#normal-setting').removeClass('selected');
            $('#hard-setting').removeClass('selected');
            $(this).addClass('selected');
        });
        
        $("#save-settings-button").click(function(event) {
            $(this).text('Saving...');
            nyanGame.saveSettings();
            nyanGame.saveData();
            $(this).animate({
                backgroundColor: "#C0C0C0"
            }, 500 ).animate({
                backgroundColor: "#38814F"
            }, 500 ).text('Saved!');
        });
        
        $("#restart-button").click(function(event) {
            nyanGame.initGame();
        });
        
        $("#submit-score-button").click(function(event) {
            console.log("testing");
            $('#submit-score-button').css({
                'visibility' : 'hidden'
            });
            $('#gameover > button.dummy-saving-button').fadeIn(0);
            nyanGame.saveScore();
            nyanGame.saveData();
            $('#gameover > button.dummy-saving-button').fadeOut(750);
            $('#gameover > input[name="username"]').fadeOut(750, function() {
                $('#gameover > h2').fadeIn(100);
            });
        });
        
        // http://stackoverflow.com/questions/1996747/add-new-value-to-an-existing-array-in-javascript
        $(document.body).on('click', "td[id^='cell-'][class='active']" ,function() {
            nyanGame.selectCell($(this).attr('id'));
        });
        
        $(document.body).on('click', "td[id^='cell-'][class='selected']" ,function() {
            nyanGame.unselectCell($(this).attr('id'));
        });
        

        /*
        Getting viewport units supported everywhere:
        http://stackoverflow.com/questions/13948713/is-there-any-cross-browser-javascript-for-making-vh-and-vw-units-work
        http://stackoverflow.com/questions/3236511/set-font-size-in-jquery
        http://html5please.com/#fallback
        http://caniuse.com/#feat=viewport-units
        http://caniuse.com/viewport-units
        http://forums.udacity.com/questions/100140926/vw-vh-vmin-vmax-are-not-well-supported-on-mobile-browsers
        https://developer.mozilla.org/en-US/docs/Mozilla/Mobile/Viewport_meta_tag?redirectlocale=en-US&redirectslug=Mobile%2FViewport_meta_tag
        */
        function viewport() {
            var e = window, a = 'inner';
            if (!('innerWidth' in window )) {
                a = 'client';
                e = document.documentElement || document.body;
            }
            return { width : e[ a+'Width' ] , height : e[ a+'Height' ] };
        }
        jQuery(window).resize(function(){        
            var vh = (viewport().height/100);
            var vw = (viewport().width/100);
            
            console.log('vw = ' + (viewport().width/100));
            console.log('vh = ' + (viewport().height/100));
            console.log('vmin = ' + Math.min((viewport().height/100), (viewport().width/100)));
            console.log('width = '+ viewport().width);
            console.log('estimated game width = ' + vh * 66.67);
            //currently fixed to a 3:2 aspect ratio
            // TODO: change this based on media queries.
            var vcalc = Math.min(vh, viewport().width/66.67);
            jQuery('html').css({
                'font-size' : vcalc + 'px'
            });
        });

        /* This enables fastclick.js */
        window.addEventListener('load', function() {
            FastClick.attach(document.body);
        }, false);
        
        /**
         * Disable scrolling on touch devices since we size the game to fit without needing to scroll.
         * http://stackoverflow.com/questions/4770025/how-to-disable-scrolling-temporarily
         * http://stackoverflow.com/questions/8488447/iphone-web-app-stop-body-scrolling
         * Note: You need both this javascript and some css to stop scrolling in all scenarios.
         */
        document.ontouchmove = function(event){
            event.preventDefault();
        }
        
        $(document).ready(function() {
            /* Do an initial resize to get the viewport to rem to pixel units set. */
            $(window).resize();
            nyanGame.loadSaveData();
        });
    </script>
  </body>
</html>